# OptimAIze Teams Bot

Microsoft Teams integration for the OptimAIze RAG system, enabling Altura Engineering employees to query company documents directly from Teams.

## üöÄ Quick Start

### Prerequisites
- Azure subscription with permissions to create resources
- Azure CLI installed and logged in
- Existing OptimAIze FastAPI backend deployed to Azure
- Microsoft Teams admin access for app installation

### 1. Environment Setup

1. **Clone and navigate to the Teams bot directory:**
```bash
cd optimAIze/teams-bot
```

2. **Copy and configure environment variables:**
```bash
cp .env.sample .env
# Edit .env with your actual values
```

3. **Required environment variables:**
```bash
# Get these from your Azure Bot Service registration
MICROSOFT_APP_ID=your-bot-app-id
MICROSOFT_APP_PASSWORD=your-bot-password  # Leave empty for managed identity
MICROSOFT_APP_TENANT_ID=your-azure-tenant-id

# Your OptimAIze backend URL
OPTIMAIZE_BACKEND_URL=https://your-optimaize-backend.azurewebsites.net

# Altura tenant configuration
ALTURA_TENANT_ID=your-altura-tenant-id
ALTURA_DOMAIN=alturaengineering.com
```

### 2. Azure Deployment

**Option A: Automated Deployment (Recommended)**
```bash
# Make the deployment script executable
chmod +x azure/deploy.sh

# Run the deployment
cd azure
./deploy.sh
```

**Option B: Manual Deployment**
```bash
# Install dependencies
pip install -r requirements.txt

# Deploy manually using Azure CLI (see detailed steps below)
```

### 3. Teams App Installation

1. **Upload the generated app package:**
   - Take the `optimaize-teams-app.zip` file generated by deployment
   - Upload to Microsoft Teams Admin Center OR
   - Sideload in Teams for testing

2. **Test the bot:**
   - Open Teams
   - Find "OptimAIze Assistant" in your apps
   - Start a conversation and ask: "What is our vacation policy?"

## üèóÔ∏è Architecture

```
Teams Client (Altura employees)
        ‚Üì
Microsoft Teams Platform
        ‚Üì
Azure Bot Service
        ‚Üì
Azure App Service (Teams Bot)
        ‚Üì
HTTP Client ‚Üí OptimAIze FastAPI Backend
                    ‚Üì
            [Existing RAG Pipeline]
        ‚Üì                    ‚Üì
    Qdrant              Elasticsearch
        ‚Üì                    ‚Üì
    Ollama/LLaMA        Admin Dashboard
```

## üîß Development

### Local Development

1. **Install dependencies:**
```bash
pip install -r requirements.txt
```

2. **Set up environment:**
```bash
cp .env.sample .env
# Configure your .env file
```

3. **Run locally:**
```bash
python bot.py
```

4. **Test with Bot Framework Emulator:**
   - Download Bot Framework Emulator
   - Connect to `http://localhost:3978/api/messages`
   - Use your bot credentials for testing

### Project Structure

```
teams-bot/
‚îú‚îÄ‚îÄ bot.py                   # Main bot application
‚îú‚îÄ‚îÄ app.py                   # FastAPI wrapper for Azure
‚îú‚îÄ‚îÄ config.py                # Configuration management
‚îú‚îÄ‚îÄ optimaize_client.py      # HTTP client for OptimAIze backend
‚îú‚îÄ‚îÄ teams_handlers.py        # Teams message handlers
‚îú‚îÄ‚îÄ auth_middleware.py       # Altura tenant authentication
‚îú‚îÄ‚îÄ requirements.txt         # Python dependencies
‚îú‚îÄ‚îÄ .env.sample             # Environment template
‚îú‚îÄ‚îÄ azure/
‚îÇ   ‚îî‚îÄ‚îÄ deploy.sh           # Azure deployment script
‚îî‚îÄ‚îÄ teams-app/
    ‚îú‚îÄ‚îÄ manifest.json       # Teams app manifest
    ‚îú‚îÄ‚îÄ color.png          # App icon (color)
    ‚îî‚îÄ‚îÄ outline.png        # App icon (outline)
```

### Key Components

#### 1. **Bot Handler** (`teams_handlers.py`)
- Processes incoming Teams messages
- Handles user authentication
- Manages conversation state
- Formats responses for Teams

#### 2. **OptimAIze Client** (`optimaize_client.py`)
- HTTP client for backend communication
- Handles API timeouts and errors
- Adds Teams-specific metadata to requests

#### 3. **Authentication Middleware** (`auth_middleware.py`)
- Verifies users are Altura employees
- Checks email domain (@alturaengineering.com)
- Validates tenant membership

#### 4. **Configuration** (`config.py`)
- Centralized configuration management
- Environment variable validation
- Type-safe settings with Pydantic

## üîí Security & Authentication

### User Authentication
- **Altura Email Verification**: Only @alturaengineering.com emails allowed
- **Tenant Validation**: Checks Microsoft 365 tenant membership
- **Automatic Rejection**: Unauthorized users receive clear denial message

### Bot Authentication
- **Managed Identity**: Uses Azure managed identity for secure authentication
- **No Stored Secrets**: Eliminates need for password management
- **Azure Integration**: Seamless integration with Azure Bot Service

### Data Security
- **No Data Storage**: Bot doesn't store conversation data permanently
- **Secure Communication**: All API calls use HTTPS
- **User Isolation**: Each user's session is completely isolated

## üìä Monitoring & Analytics

### Health Monitoring
```bash
# Check bot health
curl https://your-teams-bot.azurewebsites.net/health

# Detailed status
curl https://your-teams-bot.azurewebsites.net/status
```

### Azure Logs
```bash
# View live logs
az webapp log tail --name optimaize-teams-bot-app --resource-group optimaize-teams-bot-rg

# Download logs
az webapp log download --name optimaize-teams-bot-app --resource-group optimaize-teams-bot-rg
```

### Analytics Integration
- All Teams queries are logged to your OptimAIze admin dashboard
- User metadata includes Teams user ID and email
- Conversation context tracked for analytics

## üéØ Bot Features

### Available Commands
- **General Chat**: Ask any question about company documents
- `/help` - Show help and usage instructions
- `/status` - Check system status and user access

### Smart Features
- **Typing Indicators**: Shows when bot is processing
- **Error Handling**: Graceful error messages with suggested actions
- **Context Awareness**: Maintains conversation context
- **Rich Responses**: Formatted responses with metadata

### Teams Integration
- **Personal Chats**: One-on-one conversations with the bot
- **Group Chats**: Bot responds when mentioned in group conversations
- **Team Channels**: Bot available in team channels when added
- **@Mentions**: Responds to @OptimAIze mentions in channels

## üõ†Ô∏è Troubleshooting

### Common Issues

#### 1. **Bot Not Responding**
```bash
# Check app service status
az webapp show --name optimaize-teams-bot-app --resource-group optimaize-teams-bot-rg --query state

# Restart if needed
az webapp restart --name optimaize-teams-bot-app --resource-group optimaize-teams-bot-rg

# Check logs
az webapp log tail --name optimaize-teams-bot-app --resource-group optimaize-teams-bot-rg
```

#### 2. **Authentication Errors**
- Verify `ALTURA_TENANT_ID` is correct
- Check user email domain matches `ALTURA_DOMAIN`
- Ensure managed identity is properly configured

#### 3. **Backend Connection Issues**
- Verify `OPTIMAIZE_BACKEND_URL` is accessible
- Check OptimAIze backend health endpoint
- Review network security groups and firewall rules

#### 4. **Teams App Installation Issues**
- Ensure app manifest is valid
- Check Teams admin policies allow custom apps
- Verify bot ID matches in manifest and Azure Bot Service

### Debug Mode
```bash
# Enable debug logging
az webapp config appsettings set \
  --name optimaize-teams-bot-app \
  --resource-group optimaize-teams-bot-rg \
  --settings LOG_LEVEL=DEBUG
```

### Manual Testing
```bash
# Test health endpoint
curl https://your-teams-bot.azurewebsites.net/health

# Test with Bot Framework Emulator
# Use endpoint: https://your-teams-bot.azurewebsites.net/api/messages
```

## üîÑ Updates & Maintenance

### Updating the Bot
```bash
# Pull latest changes
git pull origin main

# Redeploy
cd azure
./deploy.sh
```

### Configuration Updates
```bash
# Update app settings
az webapp config appsettings set \
  --name optimaize-teams-bot-app \
  --resource-group optimaize-teams-bot-rg \
  --settings KEY=VALUE
```

### Monitoring Best Practices
- Set up Azure alerts for app service health
- Monitor OptimAIze backend connectivity
- Review conversation logs regularly
- Track user adoption metrics

## üìà Scaling Considerations

### Performance
- Bot uses async/await for optimal performance
- Connection pooling for OptimAIze backend calls
- In-memory conversation storage (consider Redis for scale)

### High Availability
- Azure App Service provides built-in redundancy
- Consider multiple regions for global deployment
- Monitor and scale based on usage patterns

### Cost Optimization
- Use B1 tier for development, scale to production tiers as needed
- Monitor Azure costs with cost alerts
- Consider consumption-based pricing for variable workloads

## ü§ù Contributing

### Development Workflow
1. Create feature branch from main
2. Implement changes with tests
3. Update documentation
4. Submit pull request

### Code Style
- Follow PEP 8 for Python code
- Use type hints throughout
- Add docstrings for all functions
- Include error handling and logging

### Testing
```bash
# Run local tests
python -m pytest tests/

# Test with emulator
# Use Bot Framework Emulator for integration testing
```

## üìû Support

### Getting Help
- **Technical Issues**: Check logs and troubleshooting guide
- **Access Problems**: Verify Altura tenant configuration
- **Feature Requests**: Create GitHub issue with enhancement label

### Contact Information
- **Development Team**: OptimAIze team via Slack
- **IT Support**: Altura IT department
- **Emergency**: Check Azure service health dashboard

---

*Built with ‚ù§Ô∏è for Altura Engineering using Microsoft Teams AI Library*